{% extends "base.html" %}

{% block title %}FMP Analytics - FinBot{% endblock %}

{% block content %}
<div class="text-center mb-8">
  <h1 class="text-4xl font-bold text-white mb-4">
    <i class="fas fa-chart-line mr-3"></i>Financial Modeling Prep Analytics
  </h1>
  <p class="text-xl text-white opacity-90">Comprehensive Financial Data & Analysis</p>
</div>

<!-- API Usage Stats -->
<div class="bg-white rounded-2xl p-6 mb-6 card-hover">
  <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
    <i class="fas fa-tachometer-alt mr-3 text-blue-600"></i>API Usage Statistics
  </h2>
  <div id="usageStats" class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <!-- Will be populated by JavaScript -->
    <div class="text-center p-4 bg-gray-100 rounded-lg">
      <div class="text-2xl font-bold text-gray-800">--</div>
      <div class="text-sm text-gray-600">Requests Today</div>
    </div>
  </div>
</div>

<!-- Quick Actions Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
  <!-- Stock Screener Card -->
  <div class="bg-white rounded-2xl p-6 card-hover">
    <div class="flex items-center mb-4">
      <div class="p-3 bg-blue-100 rounded-xl">
        <i class="fas fa-filter text-blue-600 text-2xl"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-800 ml-4">Stock Screener</h3>
    </div>
    <p class="text-gray-600 mb-4">Find stocks based on custom criteria</p>
    <div class="space-y-2">
      <input type="number" id="marketCapMin" placeholder="Min Market Cap ($)" class="w-full p-2 border rounded">
      <input type="number" id="volumeMin" placeholder="Min Volume" class="w-full p-2 border rounded">
      <button onclick="runScreener()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
        <i class="fas fa-search mr-2"></i>Run Screener
      </button>
    </div>
  </div>

  <!-- Financial Statements Card -->
  <div class="bg-white rounded-2xl p-6 card-hover">
    <div class="flex items-center mb-4">
      <div class="p-3 bg-green-100 rounded-xl">
        <i class="fas fa-file-invoice-dollar text-green-600 text-2xl"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-800 ml-4">Financial Statements</h3>
    </div>
    <p class="text-gray-600 mb-4">Analyze company financials</p>
    <div class="space-y-2">
      <input type="text" id="financialSymbol" placeholder="Symbol (e.g., AAPL)" class="w-full p-2 border rounded">
      <select id="statementType" class="w-full p-2 border rounded">
        <option value="income">Income Statement</option>
        <option value="balance">Balance Sheet</option>
        <option value="cash">Cash Flow</option>
      </select>
      <button onclick="getFinancials()" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">
        <i class="fas fa-chart-bar mr-2"></i>Get Financials
      </button>
    </div>
  </div>

  <!-- Technical Analysis Card -->
  <div class="bg-white rounded-2xl p-6 card-hover">
    <div class="flex items-center mb-4">
      <div class="p-3 bg-purple-100 rounded-xl">
        <i class="fas fa-wave-square text-purple-600 text-2xl"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-800 ml-4">Technical Indicators</h3>
    </div>
    <p class="text-gray-600 mb-4">Technical analysis tools</p>
    <div class="space-y-2">
      <input type="text" id="technicalSymbol" placeholder="Symbol (e.g., AAPL)" class="w-full p-2 border rounded">
      <select id="indicatorType" class="w-full p-2 border rounded">
        <option value="sma">Simple Moving Average</option>
        <option value="ema">Exponential Moving Average</option>
        <option value="rsi">RSI</option>
        <option value="macd">MACD</option>
      </select>
      <button onclick="getTechnical()" class="w-full bg-purple-500 text-white p-2 rounded hover:bg-purple-600">
        <i class="fas fa-chart-line mr-2"></i>Get Indicators
      </button>
    </div>
  </div>
</div>

<!-- Results Section -->
<div class="bg-white rounded-2xl p-6 card-hover">
  <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
    <i class="fas fa-list-alt mr-3 text-orange-600"></i>Analysis Results
  </h2>
  <div id="resultsContainer" class="min-h-200">
    <div class="text-center text-gray-500 py-8">
      <i class="fas fa-search text-4xl mb-4"></i>
      <p>Run an analysis to see results here</p>
    </div>
  </div>
</div>

<!-- Market News Section -->
<div class="bg-white rounded-2xl p-6 mt-6 card-hover">
  <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
    <i class="fas fa-newspaper mr-3 text-red-600"></i>Latest Market News
  </h2>
  <div id="newsContainer">
    <!-- News will be loaded here -->
  </div>
</div>

<script>
  // Load initial data
  document.addEventListener('DOMContentLoaded', function () {
    loadUsageStats();
    loadMarketNews();
  });

  async function loadUsageStats() {
    try {
      const response = await fetch('/api/fmp/usage');
      const data = await response.json();

      if (data.status === 'success') {
        const usage = data.usage;
        document.getElementById('usageStats').innerHTML = `
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-800">${usage.requests_today || 0}</div>
                    <div class="text-sm text-blue-600">Requests Today</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-800">${usage.requests_last_hour || 0}</div>
                    <div class="text-sm text-green-600">Last Hour</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-800">${usage.daily_limit || 250}</div>
                    <div class="text-sm text-purple-600">Daily Limit</div>
                </div>
                <div class="text-center p-4 bg-orange-50 rounded-lg">
                    <div class="text-2xl font-bold text-orange-800">${Math.round((usage.requests_today / usage.daily_limit) * 100) || 0}%</div>
                    <div class="text-sm text-orange-600">Daily Usage</div>
                </div>
            `;
      }
    } catch (error) {
      console.error('Error loading usage stats:', error);
    }
  }

  async function loadMarketNews() {
    try {
      const response = await fetch('/api/fmp/news?limit=5');
      const data = await response.json();

      if (data.status === 'success') {
        const newsContainer = document.getElementById('newsContainer');
        newsContainer.innerHTML = data.news.map(article => `
                <div class="border-l-4 border-blue-500 pl-4 mb-4 bg-gray-50 p-3 rounded">
                    <div class="flex justify-between items-start">
                        <h3 class="font-semibold text-gray-800">${article.title}</h3>
                        <span class="text-sm text-gray-500">${new Date(article.publishedDate).toLocaleDateString()}</span>
                    </div>
                    <p class="text-gray-600 text-sm mt-2">${article.text?.substring(0, 150)}...</p>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${article.site}</span>
                        <a href="${article.url}" target="_blank" class="text-blue-500 hover:text-blue-700 text-sm">
                            Read More <i class="fas fa-external-link-alt ml-1"></i>
                        </a>
                    </div>
                </div>
            `).join('');
      }
    } catch (error) {
      console.error('Error loading news:', error);
    }
  }

  async function runScreener() {
    const marketCapMin = document.getElementById('marketCapMin').value;
    const volumeMin = document.getElementById('volumeMin').value;

    let url = '/api/fmp/screener?';
    if (marketCapMin) url += `market_cap_min=${marketCapMin}&`;
    if (volumeMin) url += `volume_min=${volumeMin}`;

    try {
      showLoading('resultsContainer');
      const response = await fetch(url);
      const data = await response.json();

      if (data.status === 'success') {
        displayScreenerResults(data.stocks);
      } else {
        showError(data.error);
      }
    } catch (error) {
      showError('Failed to run screener');
    }
  }

  async function getFinancials() {
    const symbol = document.getElementById('financialSymbol').value.toUpperCase();
    const statementType = document.getElementById('statementType').value;

    if (!symbol) {
      showError('Please enter a symbol');
      return;
    }

    try {
      showLoading('resultsContainer');
      const response = await fetch(`/api/fmp/financials/${symbol}?type=${statementType}`);
      const data = await response.json();

      if (data.status === 'success') {
        displayFinancials(data.data, symbol, statementType);
      } else {
        showError(data.error);
      }
    } catch (error) {
      showError('Failed to get financial data');
    }
  }

  async function getTechnical() {
    const symbol = document.getElementById('technicalSymbol').value.toUpperCase();
    const indicator = document.getElementById('indicatorType').value;

    if (!symbol) {
      showError('Please enter a symbol');
      return;
    }

    try {
      showLoading('resultsContainer');
      const response = await fetch(`/api/fmp/technical/${symbol}?indicator=${indicator}&period=50`);
      const data = await response.json();

      if (data.status === 'success') {
        displayTechnical(data.data, symbol, indicator);
      } else {
        showError(data.error);
      }
    } catch (error) {
      showError('Failed to get technical data');
    }
  }

  function displayScreenerResults(stocks) {
    const container = document.getElementById('resultsContainer');

    if (!stocks || stocks.length === 0) {
      container.innerHTML = '<div class="text-center text-gray-500 py-8">No stocks found matching your criteria</div>';
      return;
    }

    container.innerHTML = `
        <h3 class="text-xl font-bold mb-4">Stock Screener Results (${stocks.length} stocks)</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left">Symbol</th>
                        <th class="px-4 py-2 text-left">Company</th>
                        <th class="px-4 py-2 text-right">Price</th>
                        <th class="px-4 py-2 text-right">Change</th>
                        <th class="px-4 py-2 text-right">Market Cap</th>
                        <th class="px-4 py-2 text-right">Volume</th>
                    </tr>
                </thead>
                <tbody>
                    ${stocks.map(stock => `
                        <tr class="border-t hover:bg-gray-50">
                            <td class="px-4 py-2 font-semibold">${stock.symbol}</td>
                            <td class="px-4 py-2">${stock.companyName || 'N/A'}</td>
                            <td class="px-4 py-2 text-right">$${stock.price?.toFixed(2) || 'N/A'}</td>
                            <td class="px-4 py-2 text-right ${stock.changes >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${stock.changes >= 0 ? '+' : ''}${stock.changes?.toFixed(2) || '0.00'}
                            </td>
                            <td class="px-4 py-2 text-right">${formatMarketCap(stock.marketCap)}</td>
                            <td class="px-4 py-2 text-right">${formatNumber(stock.volume)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
  }

  function displayFinancials(data, symbol, type) {
    const container = document.getElementById('resultsContainer');

    if (!data || data.length === 0) {
      container.innerHTML = '<div class="text-center text-gray-500 py-8">No financial data available</div>';
      return;
    }

    const statementTitles = {
      'income': 'Income Statement',
      'balance': 'Balance Sheet',
      'cash': 'Cash Flow Statement'
    };

    container.innerHTML = `
        <h3 class="text-xl font-bold mb-4">${statementTitles[type]} - ${symbol}</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left">Period</th>
                        ${Object.keys(data[0]).filter(key => key !== 'date' && key !== 'period').map(key =>
      `<th class="px-4 py-2 text-right">${formatFinancialHeader(key)}</th>`
    ).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${data.slice(0, 5).map(period => `
                        <tr class="border-t hover:bg-gray-50">
                            <td class="px-4 py-2 font-semibold">${period.date || period.period}</td>
                            ${Object.entries(period).filter(([key]) => key !== 'date' && key !== 'period').map(([key, value]) => `
                                <td class="px-4 py-2 text-right">${formatFinancialValue(value)}</td>
                            `).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
  }

  function displayTechnical(data, symbol, indicator) {
    const container = document.getElementById('resultsContainer');

    if (!data || data.length === 0) {
      container.innerHTML = '<div class="text-center text-gray-500 py-8">No technical data available</div>';
      return;
    }

    container.innerHTML = `
        <h3 class="text-xl font-bold mb-4">${indicator.toUpperCase()} - ${symbol}</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left">Date</th>
                        <th class="px-4 py-2 text-right">Value</th>
                        <th class="px-4 py-2 text-right">Signal</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.slice(0, 10).map(item => `
                        <tr class="border-t hover:bg-gray-50">
                            <td class="px-4 py-2">${item.date || 'N/A'}</td>
                            <td class="px-4 py-2 text-right font-semibold">${item.value?.toFixed(4) || 'N/A'}</td>
                            <td class="px-4 py-2 text-right">
                                <span class="px-2 py-1 rounded text-xs ${getSignalClass(item.signal)}">
                                    ${item.signal || 'N/A'}
                                </span>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
  }

  // Utility functions
  function formatMarketCap(marketCap) {
    if (!marketCap) return 'N/A';
    if (marketCap >= 1e12) return `$${(marketCap / 1e12).toFixed(2)}T`;
    if (marketCap >= 1e9) return `$${(marketCap / 1e9).toFixed(2)}B`;
    if (marketCap >= 1e6) return `$${(marketCap / 1e6).toFixed(2)}M`;
    return `$${marketCap}`;
  }

  function formatNumber(num) {
    if (!num) return 'N/A';
    return new Intl.NumberFormat().format(num);
  }

  function formatFinancialHeader(header) {
    return header.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
  }

  function formatFinancialValue(value) {
    if (typeof value === 'number') {
      if (Math.abs(value) >= 1e9) return `$${(value / 1e9).toFixed(2)}B`;
      if (Math.abs(value) >= 1e6) return `$${(value / 1e6).toFixed(2)}M`;
      if (Math.abs(value) >= 1e3) return `$${(value / 1e3).toFixed(2)}K`;
      return `$${value.toFixed(2)}`;
    }
    return value || 'N/A';
  }

  function getSignalClass(signal) {
    const signalMap = {
      'bullish': 'bg-green-100 text-green-800',
      'bearish': 'bg-red-100 text-red-800',
      'neutral': 'bg-gray-100 text-gray-800'
    };
    return signalMap[signal?.toLowerCase()] || 'bg-gray-100 text-gray-800';
  }

  function showLoading(containerId) {
    document.getElementById(containerId).innerHTML = `
        <div class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-2xl text-blue-500 mb-2"></i>
            <p>Loading data...</p>
        </div>
    `;
  }

  function showError(message) {
    document.getElementById('resultsContainer').innerHTML = `
        <div class="text-center py-8 text-red-500">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>${message}</p>
        </div>
    `;
  }
</script>
{% endblock %}