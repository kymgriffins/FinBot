{% extends "base.html" %}

{% block title %}ICT Trading Dashboard - FinBot{% endblock %}

{% block extra_css %}
  <style>
    .level-premium {
      border-left: 4px solid #10b981;
    background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%);
    }

    .level-discount {
      border-left: 4px solid #ef4444;
    background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
    }

    .level-fvg {
      border-left: 4px solid #3b82f6;
    background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
    }

    .level-liquidity {
      border-left: 4px solid #f59e0b;
    background: linear-gradient(90deg, rgba(245, 158, 11, 0.1) 0%, transparent 100%);
  }

  .session-card {
    transition: all 0.3s ease;
    border: 1px solid #e5e7eb;
  }

  .session-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .key-time-high {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
  }

  .key-time-medium {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  }

  .setup-card {
    background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
    border: 1px solid #dbeafe;
    }
  </style>
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<div class="mb-6">
  <nav class="flex" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
      <li class="inline-flex items-center">
        <a href="{{ url_for('web.dashboard') }}"
          class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
          <i class="fas fa-home mr-2"></i>
          Dashboard
        </a>
      </li>
      <li>
        <div class="flex items-center">
          <i class="fas fa-chevron-right text-gray-400 mx-1"></i>
          <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">ICT Trading</span>
        </div>
      </li>
    </ol>
  </nav>
</div>

<!-- Page Header -->
<div class="mb-8">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">ICT Trading Dashboard</h1>
      <p class="text-gray-600">Inner Circle Trader methodology analysis and trading tools</p>
    </div>
    <div class="mt-4 md:mt-0 flex space-x-3">
      <a href="/api/ict/journal" class="btn-secondary">
        <i class="fas fa-book mr-2"></i>Trading Journal
      </a>
      <a href="/api/ict/backtest" class="btn-secondary">
        <i class="fas fa-chart-line mr-2"></i>Backtesting
      </a>
      <a href="/api/ict/market-overview" class="btn-secondary">
        <i class="fas fa-globe mr-2"></i>Market Overview
      </a>
    </div>
  </div>
</div>

<!-- Main Content -->

<!-- Control Panel -->
<div class="bg-white rounded-2xl p-6 mb-6 card-hover">
  <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
    <div class="flex-1">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">ICT Market Analysis</h2>
      <p class="text-gray-600">Analyze premium/discount levels and market structure</p>
    </div>

    <div class="flex flex-col sm:flex-row gap-3">
      <select id="symbolSelect" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        <option value="ES=F">ES Futures</option>
        <option value="NQ=F">NQ Futures</option>
        <option value="YM=F">YM Futures</option>
        <option value="CL=F">Crude Oil</option>
        <option value="GC=F">Gold</option>
        <option value="EURUSD=X">EUR/USD</option>
      </select>

      <input type="date" id="dateSelect"
        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        value="{{ datetime.now().strftime('%Y-%m-%d') }}">

      <button onclick="analyzeICTMarket()"
        class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
        <i class="fas fa-chart-line mr-2"></i>Analyze
      </button>
    </div>
  </div>
</div>

<!-- Loading State -->
<div id="loadingState" class="hidden text-center py-12">
  <i class="fas fa-spinner fa-spin text-3xl text-blue-500 mb-4"></i>
  <p class="text-gray-600">Analyzing ICT market structure...</p>
    </div>

<!-- Analysis Results -->
<div id="analysisResults" class="hidden">
  <!-- Market Overview -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
    <div class="bg-blue-50 p-4 rounded-lg">
      <div class="text-sm text-blue-600">Daily High</div>
      <div class="text-xl font-bold text-blue-800" id="dailyHigh">-</div>
    </div>
    <div class="bg-green-50 p-4 rounded-lg">
      <div class="text-sm text-green-600">Daily Low</div>
      <div class="text-xl font-bold text-green-800" id="dailyLow">-</div>
    </div>
    <div class="bg-purple-50 p-4 rounded-lg">
      <div class="text-sm text-purple-600">Daily Range</div>
      <div class="text-xl font-bold text-purple-800" id="dailyRange">-</div>
    </div>
    <div class="bg-orange-50 p-4 rounded-lg">
      <div class="text-sm text-orange-600">Market Bias</div>
      <div class="text-xl font-bold text-orange-800" id="dailyBias">-</div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-6">
    <!-- Left Column - Levels -->
    <div class="xl:col-span-2 space-y-6">
      <!-- Premium Levels -->
      <div class="bg-white rounded-2xl p-6 card-hover">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-arrow-up text-green-500 mr-2"></i>Premium Levels
        </h3>
        <div id="premiumLevels" class="space-y-2">
          <!-- Premium levels will be populated here -->
        </div>
      </div>

      <!-- Discount Levels -->
      <div class="bg-white rounded-2xl p-6 card-hover">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-arrow-down text-red-500 mr-2"></i>Discount Levels
        </h3>
        <div id="discountLevels" class="space-y-2">
          <!-- Discount levels will be populated here -->
        </div>
      </div>

      <!-- FVG & Liquidity Levels -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-white rounded-2xl p-6 card-hover">
          <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
            <i class="fas fa-gap text-blue-500 mr-2"></i>Fair Value Gaps
          </h3>
          <div id="fvgLevels" class="space-y-2">
            <!-- FVG levels will be populated here -->
          </div>
        </div>

        <div class="bg-white rounded-2xl p-6 card-hover">
          <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
            <i class="fas fa-wave-square text-orange-500 mr-2"></i>Liquidity Levels
          </h3>
          <div id="liquidityLevels" class="space-y-2">
            <!-- Liquidity levels will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Sessions & Setups -->
    <div class="space-y-6">
      <!-- Market Sessions -->
      <div class="bg-white rounded-2xl p-6 card-hover">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-clock text-purple-500 mr-2"></i>Market Sessions
        </h3>
        <div id="marketSessions" class="space-y-3">
          <!-- Sessions will be populated here -->
        </div>
      </div>

      <!-- Key Trading Times -->
      <div class="bg-white rounded-2xl p-6 card-hover">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-bell text-yellow-500 mr-2"></i>Key Trading Times
        </h3>
        <div id="keyTimes" class="space-y-2">
          <!-- Key times will be populated here -->
        </div>
      </div>

      <!-- Trading Setups -->
      <div class="bg-white rounded-2xl p-6 card-hover">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-chess-board text-indigo-500 mr-2"></i>Trading Setups
        </h3>
        <div id="tradingSetups" class="space-y-2">
          <!-- Setups will be populated here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Error State -->
<div id="errorState" class="hidden text-center py-12">
  <i class="fas fa-exclamation-triangle text-3xl text-red-500 mb-4"></i>
  <p class="text-red-600" id="errorMessage">Error loading analysis</p>
    </div>
  </div>

  <script>
  // Global variables
  let currentAnalysis = null;

  // Analyze ICT Market
  async function analyzeICTMarket() {
      const symbol = document.getElementById('symbolSelect').value;
    const date = document.getElementById('dateSelect').value;

    showLoading();
    hideResults();
    hideError();

    try {
      const response = await fetch(`/api/ict/analyze/${symbol}?date=${date}`);
      const data = await response.json();

      if (data.error) {
        showError(data.error);
        return;
      }

      currentAnalysis = data;
      displayAnalysisResults(data);

    } catch (error) {
      showError('Failed to analyze market: ' + error.message);
    }
  }

  // Display Analysis Results
  function displayAnalysisResults(analysis) {
    // Update overview
    document.getElementById('dailyHigh').textContent = `$${analysis.daily_high?.toFixed(2) || 'N/A'}`;
    document.getElementById('dailyLow').textContent = `$${analysis.daily_low?.toFixed(2) || 'N/A'}`;
    document.getElementById('dailyRange').textContent = `$${analysis.daily_range?.toFixed(2) || 'N/A'}`;
    document.getElementById('dailyBias').textContent = analysis.daily_bias || 'N/A';

    // Display levels
    displayLevels('premiumLevels', analysis.premium_levels, 'level-premium');
    displayLevels('discountLevels', analysis.discount_levels, 'level-discount');
    displayLevels('fvgLevels', analysis.fvg_levels, 'level-fvg');
    displayLevels('liquidityLevels', analysis.liquidity_levels, 'level-liquidity');

    // Display sessions
    displaySessions(analysis.sessions);

    // Display key times
    displayKeyTimes(analysis.key_times);

    // Display trading setups
    displayTradingSetups(analysis.trading_setups);

    hideLoading();
    showResults();
  }

  // Display levels
  function displayLevels(containerId, levels, levelClass) {
    const container = document.getElementById(containerId);

    if (!levels || levels.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-sm">No levels found</p>';
      return;
    }

    container.innerHTML = levels.map(level => `
            <div class="p-3 rounded-lg ${levelClass}">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-semibold text-gray-800">$${level.price?.toFixed(2)}</div>
                        <div class="text-sm text-gray-600">${level.description}</div>
                    </div>
                    <div class="text-right">
                        <span class="inline-block px-2 py-1 text-xs rounded-full bg-white bg-opacity-50">
                            Strength: ${(level.strength * 100).toFixed(1)}%
                        </span>
                    </div>
                </div>
            </div>
        `).join('');
  }

  // Display market sessions
  function displaySessions(sessions) {
    const container = document.getElementById('marketSessions');

    if (!sessions || sessions.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-sm">No session data</p>';
      return;
    }

    container.innerHTML = sessions.map(session => `
            <div class="session-card p-4 rounded-lg bg-gray-50">
                <div class="flex justify-between items-start mb-2">
                    <div class="font-semibold text-gray-800">${session.name}</div>
                    <div class="text-sm text-gray-500">${session.start_time} - ${session.end_time}</div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div>
                        <span class="text-gray-600">High:</span>
                        <span class="font-semibold ml-1">$${session.high?.toFixed(2)}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Low:</span>
                        <span class="font-semibold ml-1">$${session.low?.toFixed(2)}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Range:</span>
                        <span class="font-semibold ml-1">$${session.range?.toFixed(2)}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Profile:</span>
                        <span class="font-semibold ml-1">${session.profile}</span>
                    </div>
                </div>
            </div>
        `).join('');
  }

  // Display key trading times
  function displayKeyTimes(keyTimes) {
    const container = document.getElementById('keyTimes');

    if (!keyTimes || keyTimes.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-sm">No key times data</p>';
      return;
    }

    container.innerHTML = keyTimes.map(time => `
            <div class="p-3 rounded-lg ${getTimeImportanceClass(time.importance)}">
                <div class="flex justify-between items-center">
                    <div class="font-semibold text-gray-800">${time.time}</div>
                    <span class="px-2 py-1 text-xs rounded-full ${getImportanceBadgeClass(time.importance)}">
                        ${time.importance}
                    </span>
                </div>
                <div class="text-sm text-gray-600 mt-1">${time.event}</div>
            </div>
        `).join('');
  }

  // Display trading setups
  function displayTradingSetups(setups) {
    const container = document.getElementById('tradingSetups');

    if (!setups || setups.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-sm">No setups identified</p>';
      return;
    }

    container.innerHTML = setups.map(setup => `
            <div class="setup-card p-3 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                    <span class="text-sm font-medium text-gray-800">${setup}</span>
                </div>
            </div>
        `).join('');
  }

  // Utility functions
  function getTimeImportanceClass(importance) {
    const classMap = {
      'High': 'key-time-high',
      'Medium': 'key-time-medium',
      'Low': 'bg-gray-50'
    };
    return classMap[importance] || 'bg-gray-50';
  }

  function getImportanceBadgeClass(importance) {
    const classMap = {
      'High': 'bg-red-100 text-red-800',
      'Medium': 'bg-yellow-100 text-yellow-800',
      'Low': 'bg-gray-100 text-gray-800'
    };
    return classMap[importance] || 'bg-gray-100 text-gray-800';
  }

  function showLoading() {
    document.getElementById('loadingState').classList.remove('hidden');
  }

  function hideLoading() {
    document.getElementById('loadingState').classList.add('hidden');
  }

  function showResults() {
    document.getElementById('analysisResults').classList.remove('hidden');
  }

  function hideResults() {
    document.getElementById('analysisResults').classList.add('hidden');
  }

  function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorState').classList.remove('hidden');
    hideLoading();
  }

  function hideError() {
    document.getElementById('errorState').classList.add('hidden');
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function () {
    // Auto-analyze ES=F on page load
    analyzeICTMarket();
  });
  </script>
{% endblock %}