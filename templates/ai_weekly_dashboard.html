{% extends "base.html" %}

{% block title %}AI Weekly Analysis - FinBot{% endblock %}

{% block extra_css %}
<style>
  .ai-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    transition: all 0.3s ease;
  }

  .ai-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
  }

  .market-phase {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    text-transform: uppercase;
    font-size: 0.8rem;
  }

  .phase-trend {
    background: linear-gradient(45deg, #10b981, #059669);
  }

  .phase-accumulation {
    background: linear-gradient(45deg, #3b82f6, #1d4ed8);
  }

  .phase-distribution {
    background: linear-gradient(45deg, #ef4444, #dc2626);
  }

  .phase-consolidation {
    background: linear-gradient(45deg, #6b7280, #4b5563);
  }

  .confidence-bar {
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
    transition: width 0.5s ease;
  }

  .prediction-card {
    border-left: 4px solid;
    transition: all 0.3s ease;
  }

  .prediction-bullish {
    border-color: #10b981;
  }

  .prediction-bearish {
    border-color: #ef4444;
  }

  .prediction-neutral {
    border-color: #6b7280;
  }

  .level-indicator {
    position: relative;
    height: 4px;
    background: #e5e7eb;
    border-radius: 2px;
    margin: 8px 0;
  }

  .level-indicator::after {
    content: '';
    position: absolute;
    top: -2px;
    height: 8px;
    width: 2px;
    background: #3b82f6;
    border-radius: 1px;
  }

  .insight-item {
    background: rgba(59, 130, 246, 0.1);
    border-left: 3px solid #3b82f6;
    padding: 12px;
    margin: 8px 0;
    border-radius: 0 8px 8px 0;
  }

  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  .metric-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }

  .metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }
</style>
{% endblock %}

{% block content %}
<div class="text-center mb-8">
  <h1 class="text-4xl font-bold text-white mb-4">
    <i class="fas fa-brain mr-3"></i>AI Weekly Analysis
  </h1>
  <p class="text-xl text-white opacity-90">Advanced Market Structure Analysis with AI Predictions</p>
</div>

<!-- Control Panel -->
<div class="ai-card p-6 mb-6">
  <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
    <div class="flex-1">
      <h2 class="text-2xl font-bold mb-2">AI Market Analyzer</h2>
      <p class="text-blue-100">Advanced pattern recognition and predictive modeling</p>
    </div>

    <div class="flex flex-col sm:flex-row gap-3">
      <select id="symbolSelect"
        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white text-gray-800">
        {% for symbol in symbols %}
        <option value="{{ symbol }}">{{ symbol }}</option>
        {% endfor %}
      </select>

      <select id="weeksSelect"
        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white text-gray-800">
        <option value="2">2 Weeks</option>
        <option value="4" selected>4 Weeks</option>
        <option value="8">8 Weeks</option>
        <option value="12">12 Weeks</option>
      </select>

      <button onclick="analyzeWithAI()"
        class="bg-white text-blue-600 px-6 py-2 rounded-lg hover:bg-blue-50 transition-colors font-semibold">
        <i class="fas fa-robot mr-2"></i>AI Analyze
      </button>

      <button onclick="compareMultiple()"
        class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
        <i class="fas fa-balance-scale mr-2"></i>Compare
      </button>
    </div>
  </div>
</div>

<!-- Analysis Results -->
<div id="analysisResults" class="hidden">
  <!-- Market Structure Overview -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="marketStructure">
    <!-- Will be populated by JavaScript -->
  </div>

  <!-- Daily Profiles -->
  <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 mb-6" id="dailyProfiles">
    <!-- Will be populated by JavaScript -->
  </div>

  <!-- AI Narrative -->
  <div class="ai-card p-6 mb-6">
    <h2 class="text-2xl font-bold mb-4 flex items-center">
      <i class="fas fa-comments mr-3"></i>AI Market Narrative
    </h2>
    <div id="aiNarrative">
      <div class="text-center text-blue-100 py-8">
        <i class="fas fa-brain text-3xl mb-3"></i>
        <p>Click "AI Analyze" to generate market narrative</p>
      </div>
    </div>
  </div>

  <!-- Trading Insights -->
  <div class="bg-white rounded-2xl p-6 mb-6 card-hover">
    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
      <i class="fas fa-lightbulb mr-3 text-yellow-600"></i>AI Trading Insights
    </h2>
    <div id="tradingInsights">
      <div class="text-center text-gray-500 py-8">
        <i class="fas fa-chart-line text-3xl mb-3"></i>
        <p>AI analysis will provide actionable trading insights</p>
      </div>
    </div>
  </div>

  <!-- Predictions -->
  <div class="bg-white rounded-2xl p-6 card-hover">
    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
      <i class="fas fa-crystal-ball mr-3 text-purple-600"></i>AI Predictions
    </h2>
    <div id="aiPredictions">
      <div class="text-center text-gray-500 py-8">
        <i class="fas fa-magic text-3xl mb-3"></i>
        <p>AI will predict next week's market behavior</p>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div id="loadingState" class="hidden text-center py-12">
  <div class="loading-spinner mx-auto mb-4"></div>
  <p class="text-gray-600">AI is analyzing market structure...</p>
</div>

<script>
  let currentAnalysis = null;

  async function analyzeWithAI() {
    const symbol = document.getElementById('symbolSelect').value;
    const weeks = document.getElementById('weeksSelect').value;

    showLoading();

    try {
      const response = await fetch(`/ai-weekly/analyze/${symbol}?weeks=${weeks}`);
      const data = await response.json();

      if (data.status === 'success') {
        currentAnalysis = data;
        displayAnalysis(data);
        showResults();
      } else {
        showError(data.error);
      }
    } catch (error) {
      showError('Failed to analyze with AI');
    }
  }

  async function compareMultiple() {
    const symbols = ['SPY', 'QQQ', 'AAPL', 'MSFT', 'TSLA'];

    showLoading();

    try {
      const response = await fetch(`/ai-weekly/compare?symbols=${symbols.join(',')}`);
      const data = await response.json();

      if (data.status === 'success') {
        displayComparison(data.comparisons);
        showResults();
      } else {
        showError(data.error);
      }
    } catch (error) {
      showError('Failed to compare symbols');
    }
  }

  function displayAnalysis(analysis) {
    displayMarketStructure(analysis.market_structure);
    displayDailyProfiles(analysis.daily_profiles);
    displayAINarrative(analysis.narrative);
    displayTradingInsights(analysis.insights);
    displayPredictions(analysis.predictions);
  }

  function displayMarketStructure(structure) {
    const container = document.getElementById('marketStructure');

    container.innerHTML = `
    <div class="metric-card">
      <div class="text-sm text-gray-600 mb-2">Current Price</div>
      <div class="text-2xl font-bold text-gray-800">$${structure.current_price?.toFixed(2)}</div>
      <div class="text-xs text-gray-500 mt-1">Range Position: ${structure.range_percentage?.toFixed(1)}%</div>
    </div>

    <div class="metric-card">
      <div class="text-sm text-gray-600 mb-2">Weekly High</div>
      <div class="text-2xl font-bold text-green-600">$${structure.weekly_high?.toFixed(2)}</div>
      <div class="text-xs text-gray-500 mt-1">Resistance Level</div>
    </div>

    <div class="metric-card">
      <div class="text-sm text-gray-600 mb-2">Weekly Low</div>
      <div class="text-2xl font-bold text-red-600">$${structure.weekly_low?.toFixed(2)}</div>
      <div class="text-xs text-gray-500 mt-1">Support Level</div>
    </div>

    <div class="metric-card">
      <div class="text-sm text-gray-600 mb-2">Market Phase</div>
      <div class="market-phase phase-${structure.market_phase} mt-2">${structure.market_phase}</div>
      <div class="text-xs text-gray-500 mt-2">Trend: ${structure.trend?.direction}</div>
    </div>
  `;
  }

  function displayDailyProfiles(profiles) {
    const container = document.getElementById('dailyProfiles');

    container.innerHTML = profiles.map(profile => `
    <div class="metric-card">
      <div class="flex justify-between items-start mb-3">
        <div class="text-lg font-semibold text-gray-800">${new Date(profile.date).toLocaleDateString('en-US', { weekday: 'short' })}</div>
        <div class="market-phase phase-${profile.market_phase}">${profile.market_phase}</div>
      </div>

      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-600">Open:</span>
          <span class="font-semibold">$${profile.open?.toFixed(2)}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Close:</span>
          <span class="font-semibold">$${profile.close?.toFixed(2)}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Range:</span>
          <span class="font-semibold">$${profile.range_size?.toFixed(2)}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Body:</span>
          <span class="font-semibold">${(profile.body_percentage * 100)?.toFixed(1)}%</span>
        </div>
      </div>

      <div class="mt-3 pt-3 border-t">
        <div class="text-xs text-gray-600">${profile.profile_type}</div>
      </div>
    </div>
  `).join('');
  }

  function displayAINarrative(narrative) {
    const container = document.getElementById('aiNarrative');

    container.innerHTML = `
    <div class="bg-white bg-opacity-10 rounded-lg p-6">
      <div class="flex items-start">
        <i class="fas fa-robot text-2xl mr-4 mt-1"></i>
        <div>
          <h3 class="text-xl font-bold mb-2">AI Analysis</h3>
          <p class="text-blue-100 leading-relaxed">${narrative}</p>
        </div>
      </div>
    </div>
  `;
  }

  function displayTradingInsights(insights) {
    const container = document.getElementById('tradingInsights');

    container.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      ${insights.map((insight, index) => `
        <div class="insight-item">
          <div class="flex items-start">
            <div class="flex-shrink-0 w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center mr-3 text-xs font-bold">
              ${index + 1}
            </div>
            <p class="text-gray-700">${insight}</p>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  }

  function displayPredictions(predictions) {
    const container = document.getElementById('aiPredictions');

    const confidence = (predictions.confidence * 100).toFixed(1);

    container.innerHTML = `
    <div class="mb-6">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm text-gray-600">AI Confidence</span>
        <span class="text-sm font-semibold">${confidence}%</span>
      </div>
      <div class="confidence-bar" style="width: ${confidence}%"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      ${predictions.scenarios.map(scenario => `
        <div class="prediction-card prediction-${scenario.type} p-4 rounded-lg">
          <div class="flex justify-between items-center mb-2">
            <span class="font-semibold capitalize">${scenario.type}</span>
            <span class="text-sm font-bold">${(scenario.probability * 100).toFixed(1)}%</span>
          </div>
          <div class="text-sm text-gray-600 mb-2">Target: $${scenario.target?.toFixed(2)}</div>
          <div class="text-xs text-gray-500">${scenario.description}</div>
        </div>
      `).join('')}
    </div>

    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
      <h4 class="font-semibold text-gray-800 mb-2">Key Levels</h4>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <span class="text-gray-600">Resistance:</span>
          <span class="font-semibold text-red-600">$${predictions.key_levels?.resistance?.toFixed(2)}</span>
        </div>
        <div>
          <span class="text-gray-600">Support:</span>
          <span class="font-semibold text-green-600">$${predictions.key_levels?.support?.toFixed(2)}</span>
        </div>
      </div>
    </div>
  `;
  }

  function displayComparison(comparisons) {
    // Implementation for comparison view
    console.log('Comparison data:', comparisons);
    alert('Multi-symbol comparison would be displayed here');
  }

  function showLoading() {
    document.getElementById('analysisResults').classList.add('hidden');
    document.getElementById('loadingState').classList.remove('hidden');
  }

  function showResults() {
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('analysisResults').classList.remove('hidden');
  }

  function showError(message) {
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('analysisResults').classList.remove('hidden');

    // Show error in all sections
    ['aiNarrative', 'tradingInsights', 'aiPredictions'].forEach(id => {
      document.getElementById(id).innerHTML = `
      <div class="text-center py-8 text-red-500">
        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
        <p>${message}</p>
      </div>
    `;
    });
  }
</script>
{% endblock %}